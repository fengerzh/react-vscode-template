# 请求处理与类型安全

<cite>
**Referenced Files in This Document**   
- [src/services/index.ts](file://src/services/index.ts)
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx)
- [src/pages/home.tsx](file://src/pages/home.tsx)
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心类型定义](#核心类型定义)
3. [API服务实现](#api服务实现)
4. [类型安全的请求处理](#类型安全的请求处理)
5. [组件中的服务调用](#组件中的服务调用)
6. [分页请求处理](#分页请求处理)
7. [错误处理机制](#错误处理机制)
8. [测试验证](#测试验证)

## 项目结构

项目采用模块化结构，将服务逻辑集中管理。`src/services/index.ts` 文件作为API服务的统一入口，定义了所有与后端交互的函数和相关类型。页面组件位于 `src/pages` 目录下，通过导入服务函数实现数据获取和提交。

```mermaid
graph TB
subgraph "服务层"
Services[src/services/index.ts]
end
subgraph "页面层"
Login[src/pages/User/Login.tsx]
Home[src/pages/home.tsx]
end
subgraph "测试层"
ServicesTest[src/__tests__/services.test.tsx]
end
Login --> Services
Home --> Services
ServicesTest --> Services
```

**Diagram sources**
- [src/services/index.ts](file://src/services/index.ts#L1-L212)
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx#L1-L162)
- [src/pages/home.tsx](file://src/pages/home.tsx#L1-L295)

**Section sources**
- [src/services/index.ts](file://src/services/index.ts#L1-L212)
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx#L1-L162)
- [src/pages/home.tsx](file://src/pages/home.tsx#L1-L295)

## 核心类型定义

在 `src/services/index.ts` 中定义了关键的TypeScript接口，为API调用提供类型安全保证。这些接口确保了请求参数和响应数据的结构一致性。

```mermaid
classDiagram
class ApiResponse~T~ {
+data : T
+success : boolean
+message? : string
+code? : number
+total? : number
}
class LoginParams {
+phone : string
+captcha : string
}
class LoginResponse {
+userName : string
+userId? : string
+token? : string
}
class User {
+id : number
+name : string
+age : number
+birthday? : string
+email? : string
+phone? : string
}
class PaginationParams {
+current? : number
+pageSize? : number
+[key : string] : unknown
}
class PaginatedResponse~T~ {
+data : T[]
+success : boolean
+total : number
+current? : number
+pageSize? : number
}
ApiResponse~LoginResponse~ <|-- LoginResponse
ApiResponse~User~ <|-- User
PaginatedResponse~User~ <|-- User
```

**Diagram sources**
- [src/services/index.ts](file://src/services/index.ts#L5-L45)

**Section sources**
- [src/services/index.ts](file://src/services/index.ts#L5-L45)

## API服务实现

`src/services/index.ts` 文件创建了Axios实例并配置了请求和响应拦截器，实现了统一的请求处理逻辑。该文件导出了多个API函数，如 `login` 和 `getUsers`，这些函数都使用泛型来确保类型安全。

```mermaid
sequenceDiagram
participant Component as "页面组件"
participant Service as "API服务"
participant Axios as "Axios实例"
participant Interceptor as "拦截器"
participant Server as "后端服务器"
Component->>Service : 调用login(params)
Service->>Interceptor : 请求拦截器
Interceptor->>Interceptor : 添加Authorization头
Interceptor->>Axios : 发送请求
Axios->>Server : POST /login
Server-->>Axios : 响应数据
Axios->>Interceptor : 响应拦截器
Interceptor->>Interceptor : 检查业务状态码
Interceptor-->>Service : 返回响应
Service-->>Component : 返回AxiosResponse
```

**Diagram sources**
- [src/services/index.ts](file://src/services/index.ts#L47-L212)

**Section sources**
- [src/services/index.ts](file://src/services/index.ts#L47-L212)

## 类型安全的请求处理

通过TypeScript泛型，API函数能够确保请求和响应数据的类型安全。`login` 函数接受 `LoginParams` 类型的参数，并返回 `AxiosResponse<ApiResponse<LoginResponse>>` 类型的Promise。

```mermaid
flowchart TD
Start([开始调用login]) --> TypeCheck["类型检查: LoginParams"]
TypeCheck --> Request["发送请求"]
Request --> Interceptor["请求拦截器添加token"]
Interceptor --> Send["发送到服务器"]
Send --> Response["接收响应"]
Response --> ResponseInterceptor["响应拦截器处理"]
ResponseInterceptor --> BusinessCheck["检查业务success状态"]
BusinessCheck --> |success=true| ReturnSuccess["返回数据"]
BusinessCheck --> |success=false| ThrowError["抛出错误"]
ReturnSuccess --> End([返回AxiosResponse])
ThrowError --> End
```

**Diagram sources**
- [src/services/index.ts](file://src/services/index.ts#L204-L204)

**Section sources**
- [src/services/index.ts](file://src/services/index.ts#L204-L204)
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx#L27-L162)

## 组件中的服务调用

在页面组件中，通过导入服务函数并正确处理返回的 `AxiosResponse` 对象来实现API调用。`Login.tsx` 组件展示了如何使用 `login` 函数进行用户登录。

```mermaid
sequenceDiagram
participant Login as "Login组件"
participant Store as "用户状态Store"
participant Message as "消息提示"
Login->>Login : 用户提交表单
Login->>Login : 调用login函数
Login->>Login : 显示乐观更新状态
Login->>Login : 处理响应
alt 登录成功
Login->>Message : 显示"登录成功"
Login->>Store : 设置用户信息
Login->>Login : 设置cookie
Login->>Login : 跳转到dashboard
else 登录失败
Login->>Message : 显示错误信息
end
Login->>Login : 清除乐观更新状态
```

**Diagram sources**
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx#L27-L162)

**Section sources**
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx#L27-L162)

## 分页请求处理

`getUsers` 函数展示了如何处理分页请求。通过传递 `PaginationParams` 参数，可以实现分页数据的获取，并使用 `PaginatedResponse<User>` 类型确保响应数据的结构正确。

```mermaid
sequenceDiagram
participant Home as "Home组件"
participant Table as "ProTable"
participant Service as "getUsers服务"
Table->>Home : request(params)
Home->>Service : getUsers(params)
Service->>Service : 发送POST请求
Service->>Service : 处理响应
Service-->>Home : 返回分页数据
Home-->>Table : 返回表格数据
Table->>Table : 渲染用户列表
```

**Diagram sources**
- [src/pages/home.tsx](file://src/pages/home.tsx#L104-L134)

**Section sources**
- [src/pages/home.tsx](file://src/pages/home.tsx#L104-L134)

## 错误处理机制

系统实现了全面的错误处理机制，包括请求拦截器、响应拦截器和组件级别的错误处理。当发生错误时，系统会根据HTTP状态码显示相应的错误消息。

```mermaid
flowchart TD
A[请求失败] --> B{错误类型}
B --> |HTTP响应| C[检查状态码]
C --> D{状态码}
D --> |401| E["显示'登录已过期'并跳转"]
D --> |403| F["显示'没有权限访问'"]
D --> |404| G["显示'资源不存在'"]
D --> |500| H["显示'服务器内部错误'"]
D --> |其他| I["显示具体错误信息"]
B --> |网络连接| J["显示'网络连接失败'"]
B --> |请求配置| K["显示'请求配置错误'"]
E --> L[结束]
F --> L
G --> L
H --> L
I --> L
J --> L
K --> L
```

**Diagram sources**
- [src/services/index.ts](file://src/services/index.ts#L108-L158)

**Section sources**
- [src/services/index.ts](file://src/services/index.ts#L108-L158)

## 测试验证

通过单元测试验证了API服务的正确性。`src/__tests__/services.test.tsx` 文件包含了对 `login` 和 `getUsers` 函数的测试用例，确保它们在各种情况下都能正确工作。

```mermaid
flowchart TD
A[测试开始] --> B[设置Mock环境]
B --> C[测试登录成功]
C --> D[验证响应状态]
D --> E[验证返回数据]
E --> F[测试登录失败]
F --> G[验证错误处理]
G --> H[测试分页功能]
H --> I[验证分页参数]
I --> J[测试错误状态码]
J --> K[验证错误消息]
K --> L[测试结束]
```

**Diagram sources**
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)

**Section sources**
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)