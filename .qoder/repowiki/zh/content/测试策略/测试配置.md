# 测试配置

<cite>
**本文档中引用的文件**  
- [jest.config.ts](file://jest.config.ts)
- [cypress.config.ts](file://cypress.config.ts)
- [jest.setup.ts](file://jest.setup.ts)
- [cypress/support/commands.ts](file://cypress/support/commands.ts)
- [src/pages/User/Login.spec.tsx](file://src/pages/User/Login.spec.tsx)
- [src/__tests__/App.test.tsx](file://src/__tests__/App.test.tsx)
- [src/pages/User/matchMedia.mock.ts](file://src/pages/User/matchMedia.mock.ts)
</cite>

## 目录
1. [简介](#简介)
2. [Jest 配置详解](#jest-配置详解)
3. [Cypress 配置详解](#cypress-配置详解)
4. [测试环境初始化](#测试环境初始化)
5. [测试配置最佳实践](#测试配置最佳实践)
6. [测试工作流支持](#测试工作流支持)
7. [结论](#结论)

## 简介
本项目采用 Jest 和 Cypress 作为核心测试框架，分别负责单元测试与端到端（E2E）测试。Jest 用于验证组件、服务和状态管理模块的逻辑正确性，而 Cypress 则确保用户界面在真实浏览器环境中的行为符合预期。通过合理的配置，测试框架能够高效运行，支持别名路径解析、模块模拟、覆盖率收集等功能，为项目质量提供坚实保障。

## Jest 配置详解

Jest 的核心配置位于 `jest.config.ts` 文件中，定义了测试环境、转换规则、模块映射等关键选项。

### transform 配置
`transform` 用于指定如何处理不同类型的文件。项目中配置如下：
```ts
transform: {
  "^.+\\.(ts|tsx|js|jsx)$": "ts-jest",
}
```
该规则表示所有 `.ts`、`.tsx`、`.js` 和 `.jsx` 文件都将通过 `ts-jest` 进行转换，从而支持 TypeScript 语法和类型检查，确保测试代码能正确解析和执行。

### moduleNameMapper 配置
`moduleNameMapper` 提供模块路径别名支持，提升代码可读性和维护性。关键配置包括：
```ts
moduleNameMapper: {
  "^.+\\.(css|styl|less|sass|scss|png|jpg|ttf|woff|woff2)$": "jest-transform-stub",
  "@/(.*)": "<rootDir>/src/$1",
}
```
- 第一条规则将静态资源（如 CSS、图片、字体等）映射到 `jest-transform-stub`，避免在测试中实际加载这些文件，提高性能。
- 第二条规则实现了 `@/` 别名支持，允许开发者使用 `@/components/Home` 而非相对路径 `../../src/components/Home`，简化导入语句。

### setupFilesAfterEnv 配置
`setupFilesAfterEnv` 指定在每个测试环境初始化后执行的脚本文件：
```ts
setupFilesAfterEnv: ["<rootDir>/jest.setup.ts"]
```
此配置确保 `jest.setup.ts` 在每个测试文件运行前被加载，用于设置全局断言、mock 全局对象（如 `window.matchMedia`）、静音控制台输出等，统一测试环境。

### 其他重要配置
- `collectCoverage: true`：启用代码覆盖率收集，生成测试覆盖报告。
- `testEnvironment: "jsdom"`：使用 jsdom 模拟浏览器环境，适合 React 组件测试。
- `testPathIgnorePatterns: ["cypress"]`：忽略 `cypress` 目录下的文件，避免 Jest 执行 E2E 测试。

**Section sources**
- [jest.config.ts](file://jest.config.ts#L2-L19)

## Cypress 配置详解

Cypress 配置文件 `cypress.config.ts` 定义了 E2E 和组件测试的行为。

### baseUrl 配置
```ts
baseUrl: "http://localhost:3123"
```
设置应用的基础 URL，所有 `cy.visit()` 调用将基于此地址。例如，`cy.visit("/login")` 实际访问 `http://localhost:3123/login`，便于在不同环境中切换测试目标。

### specPattern 配置
```ts
specPattern: "cypress/e2e/**/*.{js,jsx,ts,tsx}"
```
指定测试文件的匹配模式，Cypress 将自动发现并运行 `cypress/e2e` 目录下所有符合条件的测试脚本，支持 JavaScript 和 TypeScript。

### setupNodeEvents 配置
```ts
setupNodeEvents(on, config) {
  return pluginConfig(on, config);
}
```
该钩子允许扩展 Cypress 的 Node.js 环境功能，如修改配置、注册任务、监听事件等。当前项目通过 `plugins/index.ts` 提供插件逻辑，保持配置简洁。

### component 测试配置
```ts
component: {
  devServer: {
    framework: "react",
    bundler: "vite",
  },
}
```
启用组件测试模式，使用 Vite 作为打包器，支持在隔离环境中快速测试单个 React 组件，提升开发效率。

**Section sources**
- [cypress.config.ts](file://cypress.config.ts#L1-L23)

## 测试环境初始化

### jest.setup.ts 中的全局设置
`jest.setup.ts` 是 Jest 测试的全局初始化文件，承担多项关键职责：

#### 断言扩展
```ts
import "@testing-library/jest-dom";
```
引入 `@testing-library/jest-dom`，提供 `toBeInTheDocument()`、`toHaveClass()` 等语义化断言方法，增强测试可读性。

#### 控制台静音
通过重写 `console.error` 和 `console.log`，过滤掉已知的无关警告（如 `window.matchMedia is not a function`），减少测试输出噪声，聚焦关键错误。

#### 全局 polyfill
```ts
g.TextEncoder = TextEncoder;
g.TextDecoder = TextDecoder;
```
为 Node.js 环境补充 `TextEncoder` 和 `TextDecoder`，避免因缺失 Web API 导致测试失败。

#### 全局对象 Mock
- `window.matchMedia`：模拟响应式媒体查询，防止组件因缺少该 API 而报错。
- `window.getComputedStyle`：返回空样式对象，避免布局相关错误。
- `window.scrollTo`：mock 滚动行为，避免副作用。

这些设置确保所有测试在一致、可控的环境中运行。

### Cypress 支持文件与全局命令
Cypress 的 `support` 目录包含全局配置和自定义命令：

#### commands.ts
该文件可定义跨测试复用的自定义命令，如：
```ts
Cypress.Commands.add('login', (email, password) => { ... })
```
虽然当前为空，但预留了扩展空间，未来可添加登录、数据清理等通用操作。

#### e2e.js 和 component.ts
分别作为 E2E 和组件测试的入口文件，在测试启动时自动加载，可用于全局钩子（`beforeEach`、`afterEach`）或全局配置。

**Section sources**
- [jest.setup.ts](file://jest.setup.ts#L1-L106)
- [cypress/support/commands.ts](file://cypress/support/commands.ts#L1-L36)

## 测试配置最佳实践

### 测试环境变量配置
建议通过 `.env.test` 文件管理测试专用环境变量，并在 `jest.config.ts` 或 `cypress.config.ts` 中读取，避免硬编码敏感信息。

### 模块模拟策略
- **静态资源**：使用 `moduleNameMapper` 映射到 `jest-transform-stub`，避免加载实际文件。
- **第三方库**：使用 `jest.mock()` 模拟外部依赖（如 `axios`、`antd`），确保测试不依赖网络或 UI 库实现。
- **API 请求**：结合 `axios-mock-adapter` 模拟 HTTP 响应，验证不同状态码下的应用行为。

### 代码覆盖率集成
Jest 内置覆盖率工具，可通过以下配置优化：
```ts
collectCoverageFrom: ["src/**/*.{ts,tsx}"],
coverageThreshold: {
  lines: 80,
  statements: 80,
  branches: 70,
  functions: 80,
}
```
设置覆盖率阈值，确保新增代码符合质量标准。

### 并行测试执行
利用 Jest 的并行执行能力，结合 `--maxWorkers` 参数提升大型测试套件的运行速度。

**Section sources**
- [jest.config.ts](file://jest.config.ts#L2-L19)
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)

## 测试工作流支持

项目中的测试配置有效支持了高效的开发-测试循环：

### 别名路径支持
`@/` 别名在测试中无缝工作，开发者无需关心相对路径深度，提升代码组织灵活性。

### 组件测试隔离
通过 Cypress 组件测试功能，可在独立环境中验证 `UserLayout` 等 UI 组件，无需启动完整应用。

### 持续集成友好
`collectCoverage` 自动生成 `coverage` 报告，可集成至 CI/CD 流程，确保每次提交都满足质量要求。

### 错误隔离与调试
`jest.setup.ts` 中的控制台静音机制有效过滤噪声，使真正的问题更易被发现。同时，`matchMedia.mock.ts` 文件可在特定测试中单独引入，实现细粒度控制。

### 真实场景模拟
`Login.spec.tsx` 示例展示了完整的端到端测试流程：模拟 API 响应、用户交互、断言 UI 变化，验证登录功能的正确性。

**Section sources**
- [src/pages/User/Login.spec.tsx](file://src/pages/User/Login.spec.tsx#L1-L84)
- [src/__tests__/App.test.tsx](file://src/__tests__/App.test.tsx#L1-L31)

## 结论
本项目的测试配置体系完整且高效，Jest 与 Cypress 各司其职，通过合理的 `transform`、`moduleNameMapper`、`setupFilesAfterEnv` 等配置，构建了稳定、可维护的测试环境。`jest.setup.ts` 提供了必要的全局初始化，而 Cypress 配置确保 E2E 测试能在真实浏览器中运行。结合最佳实践，如模块模拟、覆盖率监控和环境变量管理，该配置有效支持了敏捷开发和持续交付，为项目长期健康发展奠定基础。