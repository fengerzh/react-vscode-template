# 测试策略

<cite>
**本文档中引用的文件**  
- [jest.config.ts](file://jest.config.ts)
- [cypress.config.ts](file://cypress.config.ts)
- [App.test.tsx](file://src/__tests__/App.test.tsx)
- [login.spec.js](file://cypress/e2e/login.spec.js)
- [jest.setup.ts](file://jest.setup.ts)
- [Login.spec.tsx](file://src/pages/User/Login.spec.tsx)
- [Home.test.tsx](file://src/__tests__/components/Home.test.tsx)
- [services.test.tsx](file://src/__tests__/services.test.tsx)
- [store.test.tsx](file://src/__tests__/store.test.tsx)
- [matchMedia.mock.ts](file://src/pages/User/matchMedia.mock.ts)
</cite>

## 目录
1. [引言](#引言)
2. [项目结构与测试布局](#项目结构与测试布局)
3. [测试金字塔结构](#测试金字塔结构)
4. [单元测试实现（Jest）](#单元测试实现jest)
5. [端到端测试实现（Cypress）](#端到端测试实现cypress)
6. [测试环境配置与模拟](#测试环境配置与模拟)
7. [组件、服务与用户流程测试最佳实践](#组件服务与用户流程测试最佳实践)
8. [测试运行、覆盖率与CI集成](#测试运行覆盖率与ci集成)
9. [结论](#结论)

## 引言

本项目采用分层测试策略，结合单元测试与端到端测试，确保前端应用的稳定性与可靠性。通过 Jest 实现对组件、服务和状态管理的细粒度验证，同时使用 Cypress 验证关键用户流程和系统集成行为。测试策略遵循测试金字塔原则，强调底层单元测试的高覆盖率与快速反馈，辅以少量高价值的端到端测试覆盖核心业务路径。

**Section sources**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [cypress.config.ts](file://cypress.config.ts#L1-L23)

## 项目结构与测试布局

项目遵循典型的 React 应用结构，测试文件集中存放在 `src/__tests__` 目录下，按功能模块组织（如 components、services、store）。单元测试使用 Jest 框架，配置文件为 `jest.config.ts`，并依赖 `jest.setup.ts` 进行全局环境初始化。端到端测试使用 Cypress，配置文件为 `cypress.config.ts`，测试用例存放在 `cypress/e2e` 目录下。这种清晰的分离有助于维护测试的可读性和可维护性。

```mermaid
graph TD
A[测试策略] --> B[单元测试 Jest]
A --> C[端到端测试 Cypress]
B --> D[src/__tests__/components]
B --> E[src/__tests__/services]
B --> F[src/__tests__/store]
C --> G[cypress/e2e]
```

**Diagram sources**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [cypress.config.ts](file://cypress.config.ts#L1-L23)

**Section sources**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [cypress.config.ts](file://cypress.config.ts#L1-L23)

## 测试金字塔结构

本项目的测试金字塔由三层构成：

1.  **基础层：单元测试 (Jest)** - 占据金字塔的大部分。这些测试快速、隔离，用于验证单个函数、组件或服务的行为。例如，`services.test.tsx` 和 `store.test.tsx` 对业务逻辑和状态管理进行了详尽的覆盖。
2.  **中间层：组件测试 (Jest + Testing Library)** - 位于单元测试之上。这些测试关注组件的渲染、用户交互和 DOM 查询，但通常会模拟其依赖的服务和 API。`Login.spec.tsx` 和 `Home.test.tsx` 是此类测试的代表。
3.  **顶层：端到端测试 (Cypress)** - 占据金字塔的顶端，数量最少但价值最高。这些测试模拟真实用户在浏览器中的操作，贯穿整个应用栈，验证从 UI 到后端 API 的完整工作流。`login.spec.js` 就是一个典型的 E2E 测试，它验证了从登录到访问首页的完整流程。

这种结构确保了高开发效率（快速的单元测试）和高系统可靠性（真实的 E2E 验证）。

```mermaid
graph TD
A[端到端测试<br/>Cypress<br/>少量] --> |验证完整用户流程| B[组件测试<br/>Jest<br/>中等数量]
B --> |验证UI交互与渲染| C[单元测试<br/>Jest<br/>大量]
C --> |验证函数与逻辑| D[代码]
```

**Diagram sources**
- [login.spec.js](file://cypress/e2e/login.spec.js#L1-L24)
- [Login.spec.tsx](file://src/pages/User/Login.spec.tsx#L1-L84)
- [services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)

## 单元测试实现（Jest）

Jest 是本项目单元测试的核心框架。其配置 (`jest.config.ts`) 指定了代码转换规则（使用 `ts-jest` 处理 TypeScript）、模块映射（将 `@/` 别名映射到 `src/` 目录）和测试环境（`jsdom` 用于模拟浏览器 DOM）。

### 测试范围与实现

-   **组件测试**：使用 `@testing-library/react` 渲染组件，并通过 `screen` 查询 DOM 元素。例如，`App.test.tsx` 测试了应用根组件的渲染和路由集成，而 `Login.spec.tsx` 则深入测试了登录表单的交互逻辑，包括输入、按钮点击和 API 调用的模拟。
-   **服务测试**：`services.test.tsx` 使用 `axios-mock-adapter` 来模拟 HTTP 请求，对 `login` 和 `getUsers` 等服务函数进行测试。它覆盖了成功、失败（401, 500）和网络错误等各种场景，确保服务层的健壮性。
-   **状态管理测试**：`store.test.tsx` 测试了 Zustand 状态管理库的 `useUserStore`。它验证了状态的更新、计算属性（如 `isLoggedIn`）以及异步操作（如 `getUserInfo`）对加载状态的影响。

### 模拟与桩 (Mocking & Stubbing)

Jest 提供了强大的模拟功能。项目中广泛使用 `jest.mock()` 来模拟第三方库（如 `antd` 的 `message` 组件）和内部模块（如 `@/routes`）。对于浏览器 API，`jest.setup.ts` 统一进行了桩处理，例如 `window.matchMedia` 和 `window.getComputedStyle`，以消除测试环境中的警告和错误。

**Section sources**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [App.test.tsx](file://src/__tests__/App.test.tsx#L1-L31)
- [Login.spec.tsx](file://src/pages/User/Login.spec.tsx#L1-L84)
- [services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)
- [jest.setup.ts](file://jest.setup.ts#L1-L106)

## 端到端测试实现（Cypress）

Cypress 负责在真实的浏览器环境中执行端到端测试。其配置 (`cypress.config.ts`) 定义了测试的基地址 (`baseUrl`) 和测试文件的查找模式 (`specPattern`)。

### 测试范围与实现

`login.spec.js` 是一个典型的 E2E 测试用例。它首先使用 `cy.session()` 命令创建一个持久的登录会话，避免了每次测试都进行完整的登录流程，从而提高了测试效率。测试的核心是验证用户登录后能否成功访问首页。它通过 `cy.visit()` 导航到首页，然后使用 `cy.get()` 查找特定的 DOM 元素（如加载动画 `.ant-spin` 和页面标题 `.ant-page-header-heading-title`），并使用 `.should()` 断言来验证这些元素的状态（如“不存在”或“可见”且文本正确）。

### 优势与挑战

E2E 测试的优势在于其高保真度，能发现集成问题和真实用户会遇到的 bug。然而，它们通常较慢且更脆弱。本项目通过 `cy.session()` 优化了速度，并通过设置较长的超时时间（`{ timeout: 158000 }`）来应对网络延迟，提高了测试的稳定性。

**Section sources**
- [cypress.config.ts](file://cypress.config.ts#L1-L23)
- [login.spec.js](file://cypress/e2e/login.spec.js#L1-L24)

## 测试环境配置与模拟

### Jest 环境配置

`jest.config.ts` 是 Jest 的核心配置文件。关键配置包括：
-   `collectCoverage: true`：自动收集测试覆盖率。
-   `transform`：使用 `ts-jest` 将 TypeScript 代码转换为 Jest 可执行的 JavaScript。
-   `moduleNameMapper`：处理模块别名和静态资源（如 CSS、图片），将它们映射到 `jest-transform-stub`，避免在测试中加载真实资源。
-   `setupFilesAfterEnv`：引入 `jest.setup.ts`，用于执行全局的测试环境设置。

### 模拟数据与桩

项目通过多种方式实现模拟：
1.  **全局桩**：在 `jest.setup.ts` 中，对 `console.error` 和 `console.log` 进行了静音处理，过滤掉已知的无关紧要的错误（如 `window.matchMedia is not a function`），使测试输出更清晰。
2.  **API 模拟**：在单元测试中，使用 `axios-mock-adapter` 模拟后端 API 响应。
3.  **组件/模块模拟**：使用 `jest.mock()` 模拟 `antd` 组件和路由模块。
4.  **浏览器 API 模拟**：在 `jest.setup.ts` 和 `matchMedia.mock.ts` 中，对 `window.matchMedia` 等 API 进行了统一的模拟，确保组件在测试环境中能正常运行。

**Section sources**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [jest.setup.ts](file://jest.setup.ts#L1-L106)
- [src/pages/User/matchMedia.mock.ts](file://src/pages/User/matchMedia.mock.ts#L1-L15)

## 组件、服务与用户流程测试最佳实践

### 组件测试最佳实践
-   **关注用户行为**：使用 `@testing-library/react` 的 `userEvent` 模拟真实用户交互（如 `type`, `click`），而不是直接操作 React 状态。
-   **查询可访问性**：优先使用 `screen.getByRole`, `screen.getByText` 等基于可访问性的查询方式，而非 `getByTestId`。
-   **隔离依赖**：通过 `jest.mock()` 模拟服务调用，确保测试只关注组件本身的逻辑。

### 服务测试最佳实践
-   **全面覆盖**：为每个服务函数编写测试，覆盖正常流程、各种错误状态（401, 403, 500）和网络异常。
-   **使用 Mock Adapter**：`axios-mock-adapter` 是测试 HTTP 服务的利器，可以精确控制返回的响应。
-   **验证请求**：在测试中可以断言请求的 URL、方法和请求体是否符合预期。

### 用户流程测试最佳实践
-   **聚焦核心路径**：E2E 测试应优先覆盖最重要的用户旅程，如“注册-登录-使用核心功能”。
-   **利用会话**：使用 `cy.session()` 管理登录状态，避免在每个测试中重复登录，显著提升测试速度。
-   **合理设置超时**：为异步操作（如页面加载、API 调用）设置合理的超时时间，避免因网络波动导致测试失败。

**Section sources**
- [Login.spec.tsx](file://src/pages/User/Login.spec.tsx#L1-L84)
- [Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [login.spec.js](file://cypress/e2e/login.spec.js#L1-L24)

## 测试运行、覆盖率与CI集成

### 测试运行
-   **运行单元测试**：执行 `yarn test` 或 `npm run test`，Jest 会自动发现并运行 `src/__tests__` 目录下的所有测试。
-   **运行 E2E 测试**：执行 `yarn cypress:open` 启动 Cypress 交互式界面，或 `yarn cypress:run` 在命令行中运行所有 E2E 测试。

### 覆盖率分析
由于 `jest.config.ts` 中启用了 `collectCoverage: true`，每次运行 Jest 测试后，都会在项目根目录生成 `coverage` 文件夹。该文件夹包含详细的 HTML 报告，清晰地展示了哪些代码行、分支、函数和语句被测试覆盖，帮助开发者识别测试的薄弱环节。

### 持续集成 (CI) 集成
虽然项目中未直接提供 CI 配置文件（如 `.github/workflows`），但其测试结构非常适合集成到 CI/CD 流程中。标准的 CI 流程可以是：
1.  推送代码到仓库。
2.  CI 服务器（如 GitHub Actions）拉取代码。
3.  安装依赖 (`yarn install`)。
4.  运行单元测试和覆盖率检查 (`yarn test`)。
5.  运行端到端测试 (`yarn cypress:run`)。
6.  如果所有测试通过，则进行部署。

**Section sources**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [cypress.config.ts](file://cypress.config.ts#L1-L23)

## 结论

本项目的测试策略通过 Jest 和 Cypress 的有机结合，构建了一个高效、可靠的测试体系。Jest 提供了快速、精准的单元和组件测试，确保了代码的内部质量；Cypress 则提供了高保真的端到端验证，保障了核心用户流程的正确性。通过精心的测试环境配置、广泛的模拟和最佳实践的应用，该策略能够有效提升代码质量，加速开发迭代，并为应用的稳定运行提供坚实保障。开发者应遵循此策略，持续编写高质量的测试用例，以维护项目的长期健康。