# 单元测试

<cite>
**本文档引用的文件**
- [jest.config.ts](file://jest.config.ts)
- [jest.setup.ts](file://jest.setup.ts)
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx)
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx)
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx)
- [src/pages/home.tsx](file://src/pages/home.tsx)
- [src/services/index.ts](file://src/services/index.ts)
- [src/store/index.ts](file://src/store/index.ts)
</cite>

## 目录
1. [简介](#简介)
2. [测试环境配置](#测试环境配置)
3. [组件测试](#组件测试)
4. [服务层测试](#服务层测试)
5. [状态管理测试](#状态管理测试)
6. [测试工具与技术](#测试工具与技术)
7. [最佳实践](#最佳实践)
8. [测试运行与CI集成](#测试运行与ci集成)

## 简介
本项目采用Jest作为主要的单元测试框架，结合React Testing Library、Ant Design的测试工具和Axios Mock Adapter等技术，构建了完整的前端测试体系。测试覆盖了React组件、服务层API调用和Zustand状态管理等核心功能模块。通过合理的测试配置和模拟策略，确保了代码质量和功能稳定性。

## 测试环境配置

```mermaid
graph TD
A[Jest配置] --> B[transform配置]
A --> C[moduleNameMapper配置]
A --> D[testEnvironment配置]
A --> E[setupFilesAfterEnv配置]
B --> F[ts-jest处理TS/JS文件]
C --> G[@/别名映射到src目录]
C --> H[静态资源映射到jest-transform-stub]
D --> I[jsdom模拟浏览器环境]
E --> J[jest.setup.ts初始化测试环境]
```

**图示来源**
- [jest.config.ts](file://jest.config.ts#L1-L22)

**测试环境配置**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [jest.setup.ts](file://jest.setup.ts#L1-L106)

## 组件测试

```mermaid
sequenceDiagram
participant 测试框架 as 测试框架
participant Home组件 as Home组件
participant 服务层 as 服务层
participant DOM as DOM
测试框架->>Home组件 : renderWithRouter(<Home />)
测试框架->>服务层 : mock services.getUsers
服务层-->>测试框架 : 返回mock数据
测试框架->>Home组件 : 触发渲染
Home组件->>DOM : 渲染页面元素
DOM-->>测试框架 : 返回渲染结果
测试框架->>DOM : 查询元素并验证
测试框架->>Home组件 : 模拟用户交互
Home组件->>服务层 : 调用API
服务层-->>Home组件 : 返回结果
Home组件->>DOM : 更新UI
测试框架->>DOM : 验证状态变化
```

**图示来源**
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [src/pages/home.tsx](file://src/pages/home.tsx#L1-L295)

### Home组件测试实现

```mermaid
flowchart TD
A[测试用例开始] --> B[Mock服务层API]
B --> C[渲染Home组件]
C --> D[验证页面元素]
D --> E{测试类型}
E --> |渲染测试| F[检查标题、按钮、表格]
E --> |交互测试| G[模拟点击编辑/删除按钮]
E --> |API调用测试| H[验证getUsers被调用]
E --> |状态管理测试| I[检查乐观更新效果]
F --> J[断言元素存在]
G --> K[验证message.info被调用]
H --> L[断言API调用]
I --> M[检查乐观更新状态显示]
J --> N[测试通过]
K --> N
L --> N
M --> N
```

**图示来源**
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [src/pages/home.tsx](file://src/pages/home.tsx#L1-L295)

**测试实现**
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [src/pages/home.tsx](file://src/pages/home.tsx#L1-L295)

## 服务层测试

```mermaid
sequenceDiagram
participant 测试框架 as 测试框架
participant 服务层 as 服务层
participant AxiosMock as Axios Mock
participant AntdMock as Antd Mock
测试框架->>AxiosMock : 创建MockAdapter
测试框架->>AntdMock : Mock message组件
测试框架->>服务层 : 调用login/getUsers
服务层->>AxiosMock : 发送HTTP请求
AxiosMock-->>服务层 : 返回mock响应
服务层->>AntdMock : 调用message.error/success
AntdMock-->>服务层 : 返回结果
服务层-->>测试框架 : 返回处理结果
测试框架->>测试框架 : 验证结果和mock调用
```

**图示来源**
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [src/services/index.ts](file://src/services/index.ts#L1-L212)

### 服务层测试实现

```mermaid
flowchart TD
A[测试用例开始] --> B[创建MockAdapter]
B --> C[Mock antd message]
C --> D[设置window.location]
D --> E{测试场景}
E --> |成功场景| F[配置200响应]
E --> |失败场景| G[配置401/500响应]
E --> |网络错误| H[配置networkError]
F --> I[调用API方法]
G --> I
H --> I
I --> J[验证响应结果]
J --> K[验证message调用]
K --> L[测试通过]
```

**图示来源**
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [src/services/index.ts](file://src/services/index.ts#L1-L212)

**测试实现**
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [src/services/index.ts](file://src/services/index.ts#L1-L212)

## 状态管理测试

```mermaid
sequenceDiagram
participant 测试框架 as 测试框架
participant ZustandStore as Zustand Store
participant LocalStorage as LocalStorage
participant DOM as DOM
测试框架->>ZustandStore : renderHook(useUserStore)
测试框架->>LocalStorage : Mock localStorage
测试框架->>ZustandStore : 调用setUserInfo
ZustandStore->>ZustandStore : 更新状态
ZustandStore->>LocalStorage : 持久化数据
测试框架->>ZustandStore : 调用clearUserInfo
ZustandStore->>ZustandStore : 重置状态
ZustandStore->>LocalStorage : 清除数据
测试框架->>ZustandStore : 验证状态变化
测试框架->>ZustandStore : 验证计算属性
```

**图示来源**
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)
- [src/store/index.ts](file://src/store/index.ts#L1-L123)

### 状态管理测试实现

```mermaid
flowchart TD
A[测试用例开始] --> B[Mock localStorage]
B --> C[Mock document.cookie]
C --> D[renderHook(useUserStore)]
D --> E{测试模块}
E --> |用户信息管理| F[测试setUserInfo/clearUserInfo]
E --> |应用状态管理| G[测试setLoading/toggleTheme]
E --> |计算属性| H[测试isLoggedIn/displayName]
E --> |异步方法| I[测试getUserInfo]
F --> J[验证状态更新]
G --> J
H --> J
I --> J
J --> K[测试通过]
```

**图示来源**
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)
- [src/store/index.ts](file://src/store/index.ts#L1-L123)

**测试实现**
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)
- [src/store/index.ts](file://src/store/index.ts#L1-L123)

## 测试工具与技术

### 模块模拟技术

```mermaid
classDiagram
class MockAdapter {
+onPost(url)
+onGet(url)
+reply(status, data)
+networkError()
+reset()
+restore()
}
class jest {
+mock(moduleName, factory)
+fn()
+clearAllMocks()
+mocked(module)
}
class TestingLibrary {
+render()
+screen
+fireEvent
+waitFor()
+act()
}
class Zustand {
+renderHook()
+act()
}
MockAdapter --> jest : 使用
TestingLibrary --> jest : 使用
Zustand --> jest : 使用
TestingLibrary --> DOM : 操作
```

**图示来源**
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)

### API模拟实现

```mermaid
flowchart TD
A[创建MockAdapter] --> B[配置请求拦截]
B --> C[定义响应规则]
C --> D{响应类型}
D --> |成功响应| E[reply(200, data)]
D --> |错误响应| F[reply(401, errorData)]
D --> |网络错误| G[networkError()]
E --> H[服务层处理成功]
F --> H[服务层处理错误]
G --> H[服务层处理异常]
H --> I[验证结果]
```

**图示来源**
- [src/services/index.ts](file://src/services/index.ts#L1-L212)
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)

**模块模拟**
- [jest.setup.ts](file://jest.setup.ts#L1-L106)
- [src/__tests__/services.test.tsx](file://src/__tests__/services.test.tsx#L1-L354)
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)

## 最佳实践

### 测试覆盖率要求

```mermaid
pie
title 测试覆盖率目标
"语句覆盖率" : 85
"分支覆盖率" : 80
"函数覆盖率" : 90
"行覆盖率" : 85
```

**覆盖率配置**
- [jest.config.ts](file://jest.config.ts#L3-L4)

### 异步测试处理

```mermaid
sequenceDiagram
participant 测试 as 测试
participant 异步操作 as 异步操作
participant act as act
participant waitFor as waitFor
测试->>异步操作 : 调用异步方法
异步操作->>act : 包装状态更新
act-->>异步操作 : 执行更新
测试->>waitFor : 等待条件满足
waitFor->>测试 : 条件满足
测试->>测试 : 执行断言
```

**异步测试实现**
- [src/__tests__/components/Home.test.tsx](file://src/__tests__/components/Home.test.tsx#L1-L248)
- [src/__tests__/store.test.tsx](file://src/__tests__/store.test.tsx#L1-L227)

### 快照测试使用

```mermaid
flowchart TD
A[首次运行] --> B[渲染组件]
B --> C[生成快照]
C --> D[保存快照文件]
D --> E[后续运行]
E --> F[渲染组件]
F --> G[生成当前快照]
G --> H{与保存的快照比较}
H --> |匹配| I[测试通过]
H --> |不匹配| J[检查是否为预期变更]
J --> |预期变更| K[更新快照]
J --> |非预期变更| L[修复代码]
```

**快照测试配置**
- Jest默认支持
- [jest.config.ts](file://jest.config.ts#L1-L22)

**最佳实践**
- [jest.config.ts](file://jest.config.ts#L1-L22)
- [jest.setup.ts](file://jest.setup.ts#L1-L106)
- [src/__tests__/*](file://src/__tests__)

## 测试运行与CI集成

### 测试运行命令

```bash
# 运行所有测试
npm test

# 运行测试并生成覆盖率报告
npm test -- --coverage

# 监听模式运行测试
npm test -- --watch

# 运行特定测试文件
npm test Home.test.tsx

# 运行特定测试用例
npm test -- -t "应该正确渲染Home组件"
```

### 覆盖率报告生成

```mermaid
flowchart TD
A[运行测试] --> B[Jest收集覆盖率数据]
B --> C[生成覆盖率报告]
C --> D{报告格式}
D --> |HTML| E[coverage/index.html]
D --> |JSON| F[coverage/coverage-final.json]
D --> |LCOV| G[coverage/lcov.info]
E --> H[浏览器查看详细报告]
F --> I[CI系统分析]
G --> J[代码质量平台集成]
```

**覆盖率配置**
- [jest.config.ts](file://jest.config.ts#L3-L4)

### CI集成策略

```mermaid
flowchart LR
A[代码提交] --> B[CI系统触发]
B --> C[安装依赖]
C --> D[运行单元测试]
D --> E{测试通过?}
E --> |是| F[生成覆盖率报告]
E --> |否| G[构建失败]
F --> H{覆盖率达标?}
H --> |是| I[构建成功]
H --> |否| J[构建失败]
I --> K[部署到预发布环境]
```

**CI集成配置**
- package.json scripts
- CI配置文件（未提供）

**测试运行**
- [package.json](file://package.json)
- [jest.config.ts](file://jest.config.ts#L1-L22)