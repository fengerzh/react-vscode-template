# 构建流程

<cite>
**本文档引用的文件**  
- [package.json](file://package.json)
- [vite.config.ts](file://vite.config.ts)
- [src/tailwind/postcss.config.js](file://src/tailwind/postcss.config.js)
- [src/tailwind/tailwind.config.js](file://src/tailwind/tailwind.config.js)
- [src/App.tsx](file://src/App.tsx)
- [src/routes/index.tsx](file://src/routes/index.tsx)
- [src/layout/BasicLayout.tsx](file://src/layout/BasicLayout.tsx)
- [src/pages/User/Login.tsx](file://src/pages/User/Login.tsx)
</cite>

## 目录
1. [构建脚本概览](#构建脚本概览)
2. [Vite 构建流程详解](#vite-构建流程详解)
3. [构建输出目录结构](#构建输出目录结构)
4. [预览生产构建](#预览生产构建)
5. [开发服务器配置](#开发服务器配置)
6. [常见构建问题及解决方案](#常见构建问题及解决方案)

## 构建脚本概览

项目通过 `package.json` 中定义的 npm 脚本管理构建与开发流程。核心脚本包括：

- `build`: 执行 `vite build`，触发生产环境构建流程
- `serve`: 执行 `vite preview`，启动本地预览服务器以验证构建结果
- `start`: 执行 `vite`，启动开发服务器

这些脚本分别对应开发、构建和验证三个关键阶段，构成了完整的前端工作流。

**Section sources**
- [package.json](file://package.json#L10-L15)

## Vite 构建流程详解

执行 `npm run build` 命令时，Vite 会启动完整的生产构建流程。该流程基于 Rollup 进行代码打包，包含以下关键步骤：

1. **源码解析与依赖分析**：Vite 利用 ES 模块特性，从入口文件（如 `src/index.tsx`）开始递归解析模块依赖关系。
2. **代码编译**：通过插件系统（如 `@vitejs/plugin-react`）将 TypeScript 和 JSX 代码编译为浏览器可执行的 JavaScript。
3. **资源优化**：
   - 自动启用代码压缩（Terser）
   - 启用 Tree Shaking 消除未使用代码
   - 对 CSS 进行压缩与优化
4. **代码分割**：根据动态导入（`import()`）和路由配置自动进行代码分割，实现按需加载。
5. **静态资源处理**：图片、字体等资源被自动优化并生成哈希文件名，提升缓存效率。

构建过程中，Vite 会输出详细的构建报告，包括各 chunk 的大小和加载优先级。

**Section sources**
- [vite.config.ts](file://vite.config.ts#L1-L52)
- [package.json](file://package.json#L13)

## 构建输出目录结构

构建完成后，默认在项目根目录生成 `dist` 文件夹，其结构如下：

```
dist/
├── assets/               # 静态资源（JS、CSS、图片等）
│   ├── index-*.js        # 主入口脚本（含内容哈希）
│   ├── style-*.css       # 样式文件
│   └── logo-*.svg        # 图片资源
├── index.html            # 主 HTML 入口文件
└── favicon.ico           # 网站图标
```

`index.html` 文件会自动注入构建生成的资源路径，并启用最佳实践配置（如 `defer` 脚本加载）。所有资源均采用内容哈希命名，确保长期缓存策略的有效性。

**Section sources**
- [index.html](file://index.html)
- [vite.config.ts](file://vite.config.ts#L45-L52)

## 预览生产构建

`npm run serve` 命令执行 `vite preview`，用于在本地启动一个静态服务器以预览生产构建结果。该命令不会重新构建项目，而是直接服务 `dist` 目录中的内容。

此步骤至关重要，可用于：
- 验证生产环境下的路由跳转是否正常
- 检查资源路径是否正确加载
- 测试代码分割与懒加载行为
- 发现开发服务器中未暴露的配置问题

预览服务器默认运行在 `http://localhost:4173`，可通过浏览器访问并进行全面测试。

**Section sources**
- [package.json](file://package.json#L14)
- [vite.config.ts](file://vite.config.ts#L45-L52)

## 开发服务器配置

`npm run start` 启动 Vite 开发服务器，其行为由 `vite.config.ts` 中的 `server` 配置项控制。当前项目中明确设置了端口号：

```ts
server: {
  port: 3123,
}
```

开发服务器启动后将监听 `http://localhost:3123`。若该端口被占用，Vite 会自动尝试下一个可用端口并提示用户。

此外，开发服务器具备热模块替换（HMR）功能，支持在不刷新页面的情况下实时更新修改的模块，极大提升开发效率。

**Section sources**
- [vite.config.ts](file://vite.config.ts#L49-L51)
- [package.json](file://package.json#L12)

## 常见构建问题及解决方案

### 1. 依赖冲突或版本不兼容
**现象**：构建时报错 `Cannot find module` 或 `Duplicate module`。
**解决方案**：
- 使用 `yarn deduplicate` 检查并去重依赖
- 清理 `node_modules` 并重新安装：`rm -rf node_modules && yarn install`
- 检查 `package.json` 中是否存在冲突的依赖版本

### 2. 环境变量未生效
**现象**：`.env` 文件中的变量在构建后无法读取。
**解决方案**：
- 确保环境变量以 `VITE_` 开头（如 `VITE_API_URL`），Vite 仅暴露前缀为 `VITE_` 的变量
- 在代码中通过 `import.meta.env.VITE_API_URL` 访问
- 检查 `.env` 文件路径是否正确，推荐使用 `.env.production` 用于生产环境

### 3. Tailwind CSS 未正确生成
**现象**：样式未按预期应用，或构建后缺少某些类名。
**解决方案**：
- 确保 `tailwind.config.js` 中的 `purge` 配置包含所有源文件路径
- 检查 `postcss.config.js` 是否正确引用 Tailwind 插件
- 手动运行 `npm run css` 确认 PostCSS 处理流程正常

### 4. 构建体积过大
**现象**：生成的 JS 文件体积异常大。
**解决方案**：
- 使用 `vite-bundle-visualizer` 分析包体积构成
- 检查是否有意外引入大型库（如完整 lodash）
- 确认代码分割配置正确，避免将所有代码打包到单一 chunk

**Section sources**
- [vite.config.ts](file://vite.config.ts)
- [package.json](file://package.json)
- [src/tailwind/postcss.config.js](file://src/tailwind/postcss.config.js)
- [src/tailwind/tailwind.config.js](file://src/tailwind/tailwind.config.js)